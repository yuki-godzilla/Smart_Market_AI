# ğŸ—ï¸ System Architecture â€” Smart Market AI (Based on Refined Requirements)

## 0. Guiding Principles
- **Simplicity First**: ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã‚’å‰æã«ã€ä¾å­˜ã‚’æœ€å°åŒ–ã€‚
- **Modular Design**: UIãƒ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ»MLã‚’ç–çµåˆåŒ–ã€‚
- **Reproducibility**: åŒä¸€ãƒ‡ãƒ¼ã‚¿ãƒ»åŒä¸€ãƒ¢ãƒ‡ãƒ«ã§åŒä¸€çµæœã‚’å†ç¾ã€‚
- **Security by Default**: å¤–éƒ¨é€ä¿¡ã‚’æ¥µå°åŒ–ã€ç§˜åŒ¿æƒ…å ±ã¯æš—å·åŒ–ç®¡ç†ã€‚

---

## 1. Architecture Overview
**ç›®çš„**: NISAå¯¾å¿œã‚’å«ã‚€å€‹äººæŠ•è³‡å®¶å‘ã‘ã®é«˜é…å½“éŠ˜æŸ„é¸å®šãƒ»å¸‚å ´äºˆæ¸¬ãƒ»ãƒªã‚¹ã‚¯åˆ†æã‚’ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¸­å¿ƒã§é«˜é€Ÿã«æä¾›ã€‚  

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¹ã‚¿ã‚¤ãƒ«**: åˆ†å‰²å±¤ï¼ˆLayeredï¼‰+ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³/ãƒãƒƒãƒï¼ˆETL + ML Trainingï¼‰+ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆInference & UIï¼‰


```plantuml
@startuml
top to bottom direction
skinparam shadowing true
skinparam roundcorner 12
skinparam packageStyle rectangle
skinparam componentStyle rectangle
skinparam wrapWidth 180
skinparam maxMessageSize 180
skinparam ArrowColor #666666
skinparam defaultTextAlignment left
skinparam linetype ortho

legend top left
|= Color |= Layer |
|<#B3D7FF>| Presentation |
|<#BFEABF>| Application |
|<#F7E7A1>| Domain |
|<#F6B2B2>| Infrastructure |
endlegend

actor User #LightYellow

package "Presentation Layer" #B3D7FF {
  component "Streamlit UI\n(Local Web)" as UI
}

package "Application Layer" #BFEABF {
  component "App Controller" as APPCTRL
  component "Service Router" as ROUTER
  component "Screening Service\n(Rules / Scoring)" as SRV_SCREEN
  component "Forecast Service\n(ML Inference)" as SRV_FORE
  component "Portfolio Service\n(Optimization)" as SRV_PORT
  component "Risk Service\n(News / Indicators)" as SRV_RISK
  component "Report Service\n(PDF / Excel)" as SRV_REP
}

package "Domain Layer" #F7E7A1 {
  component "Data Access\n(Data API / Cache)" as DAO
  database "Feature Store\n(Local)" as FSTORE
  component "Model Registry\n(Local)" as MREG
  component "Job Orchestrator\n(Batch / ETL)" as ORCH
}

package "Infrastructure Layer" #F6B2B2 {
  cloud "Data Sources\n(yfinance, etc.)" as DSRC
  database "Storage\n(Local FS / SQLite)" as STOR
  component "Secrets\n(.env / OS Keychain)" as SECR
  component "Logging / Monitoring" as LOGG
}

User --> UI
UI --> APPCTRL
APPCTRL --> ROUTER

ROUTER --> SRV_SCREEN
ROUTER --> SRV_FORE
ROUTER --> SRV_PORT
ROUTER --> SRV_RISK
ROUTER --> SRV_REP

SRV_SCREEN --> DAO
SRV_SCREEN --> FSTORE
SRV_FORE   --> FSTORE
SRV_FORE   --> MREG
SRV_PORT   --> FSTORE
SRV_RISK   --> DAO
SRV_REP    --> FSTORE
SRV_REP ..> MREG

ORCH --> DSRC
ORCH --> DAO
ORCH --> FSTORE
ORCH --> MREG
ORCH --> STOR

DAO --> DSRC
DAO --> STOR
APPCTRL ..> LOGG
ROUTER  ..> LOGG
ORCH    ..> LOGG
DAO     ..> SECR

scale 1000 width
@enduml
```


---

## 2. Component Breakdown

### 2.1 Presentation Layer (UI)
- **Streamlit App**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€æ¤œç´¢ãƒ»æ¡ä»¶å…¥åŠ›ã€çµæœå¯è¦–åŒ–ã€ãƒ¬ãƒãƒ¼ãƒˆDLã€‚
- **Session State**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆæœ€ä½åˆ©å›ã‚Šã€é€šè²¨ã€ãƒªã‚¹ã‚¯è¨±å®¹åº¦ç­‰ï¼‰ã®ä¿æŒã€‚
- **Visualization**: plotly/matplotlib ã«ã‚ˆã‚‹ãƒãƒ£ãƒ¼ãƒˆã€‚

### 2.2 Application Layer (Services)
- **Screening Service**  
  - æŒ‡æ¨™ï¼ˆé…å½“åˆ©å›ã‚Šã€æˆé•·ç‡ã€è‡ªå·±è³‡æœ¬æ¯”ç‡ã€PER ç­‰ï¼‰ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã€‚  
  - é‡ã¿ä»˜ã‘å¤‰æ›´ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆã€‚  
- **Forecast Service**  
  - ä¾¡æ ¼/é…å½“ã®å›å¸°ãƒ»åˆ†é¡æ¨è«–ï¼ˆscikit-learn / XGBoost / Prophet / PyTorchï¼‰ã€‚  
  - ä¸ç¢ºå®Ÿæ€§æŒ‡æ¨™ï¼ˆäºˆæ¸¬åŒºé–“ã€ä¿¡é ¼åº¦ï¼‰ã®å‡ºåŠ›ã€‚  
- **Portfolio Service**  
  - PyPortfolioOpt/cvxpy ã§å¹³å‡åˆ†æ•£æœ€é©åŒ–ã€åˆ¶ç´„ï¼ˆéŠ˜æŸ„æ•°ã€æ¯”ç‡ä¸Šé™ã€é€šè²¨ï¼‰å¯¾å¿œã€‚  
- **Risk Service**  
  - çµŒæ¸ˆæŒ‡æ¨™ãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢é›†è¨ˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/è¾æ›¸â†’å°†æ¥ã¯NLPï¼‰ã€‚  
  - ãƒªã‚¹ã‚¯ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”Ÿæˆã€‚  
- **Report Service**  
  - PDF/Excel å‡ºåŠ›ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆä¼šç¤¾åˆ¥/ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆ¥/å¸‚å ´åˆ¥ï¼‰ã€‚  

### 2.3 Domain Layer
- **Feature Store (Local)**: ç‰¹å¾´é‡ã®è¨ˆç®—ãƒ»æ ¼ç´ï¼ˆParquet/Featherï¼‰ã€‚
- **Model Registry (Local)**: ãƒ¢ãƒ‡ãƒ«ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆå­¦ç¿’æ—¥ã€æŒ‡æ¨™ã€ãƒã‚¤ãƒ‘ãƒ©ï¼‰ã‚’ç®¡ç†ã€‚
- **Data Access**: yfinance/pandas_datareader ãªã©ã®ã‚³ãƒã‚¯ã‚¿ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã€‚
- **Job Orchestrator**: ETLãƒ»å­¦ç¿’ãƒ»è©•ä¾¡ãƒ»ãƒ¢ãƒ‡ãƒ«ç™»éŒ²ã®ãƒãƒƒãƒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚

### 2.4 Infrastructure Layer
- **Storage**: ãƒ­ãƒ¼ã‚«ãƒ«FSã€SQLiteï¼ˆãƒ¡ã‚¿/å°è¦æ¨¡DBï¼‰ã€å°†æ¥ã¯DuckDB/Lightweight-Postgresã«æ‹¡å¼µå¯ã€‚
- **Secrets**: .env + OSã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ï¼ˆå°†æ¥ Vault äº’æ›ã«å¯¾å¿œï¼‰ã€‚
- **Logging/Monitoring**: Python logging + ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆCSV/JSONï¼‰ã€‚

---

## 3. Data Flow (ETL & Inference)

### 3.1 Batch Pipeline (Daily/Weekly)
1. **Extract**: yfinance ç­‰ã‹ã‚‰æ ªä¾¡ãƒ»é…å½“ãƒ»æŒ‡æ¨™ã‚’å–å¾—ã€‚  
2. **Transform**: æ¬ æå‡¦ç†ã€é€šè²¨æ›ç®—ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¨™æº–åŒ–ã€‚  
3. **Feature Build**: ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«/ãƒ•ã‚¡ãƒ³ãƒ€ç‰¹å¾´é‡ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½œæˆã€‚  
4. **Train**: ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ï¼ˆCV/æ™‚ç³»åˆ—åˆ†å‰²ï¼‰â†’ æŒ‡æ¨™ç®—å‡ºï¼ˆRMSE/ROC/PRï¼‰ã€‚  
5. **Register**: ãƒ¢ãƒ‡ãƒ«ãƒ»ç‰¹å¾´é‡ã‚’ Model Registry / Feature Store ã¸ç™»éŒ²ã€‚  
6. **Validate**: ãƒã‚¤ã‚¢ã‚¹/ãƒ‰ãƒªãƒ•ãƒˆç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã€ã—ãã„å€¤è©•ä¾¡ã€‚  

### 3.2 Inference Path (On-demand)
UIå…¥åŠ› â†’ Data Access (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª) â†’ Feature Store â†’ Forecast Service â†’ çµæœè¡¨ç¤ºãƒ»ä¿å­˜ã€‚

---

## 4. Deployment View
- **Local (Default)**: å˜ä¸€ãƒã‚·ãƒ³ã§ã®å®Ÿè¡Œï¼ˆPython + Streamlitï¼‰ã€‚
- **Optional Container**: Docker åŒ–ï¼ˆå†ç¾æ€§å‘ä¸Šï¼‰ã€‚
- **Scheduler**: Windows Task Scheduler / cron ã§ãƒãƒƒãƒèµ·å‹•ã€‚

```plantuml
@startuml
top to bottom direction
skinparam shadowing true
skinparam roundcorner 12

node "User PC" as PC {
  component "Streamlit UI\n(run app.py)" as UI2 #LightSkyBlue
  component "Scheduler\n(Windows Task / cron)" as SCH #LightGreen
  database  "Local Storage\n(./data, ./models, ./reports)" as LST #LightGray
}

' â–¼ è¿½åŠ ï¼šã©ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èµ·å‹•ã™ã‚‹ã‹æ³¨é‡ˆ
SCH -down-> LST : outputs\n(features / models / reports)
SCH -left-> UI2 : optional: nightly refresh notice

' â–¼ æ–°è¦ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆåã‚’æ³¨é‡ˆã§æ˜ç¤º
note right of SCH
  Triggers:
    - batch/etl_daily.py
    - batch/retrain_weekly.py
end note

UI2 --> LST : read/write\n(cache, reports)
@enduml
```

---

## 5. Data Model (Logical)
- **MarketData**: symbol, date, ohlcv, dividends, splits, currency  
- **Fundamentals**: symbol, period, revenue, eps, roe, debt_ratio, payout  
- **Features**: symbol, date, feature_vector (Parquet)  
- **Models**: model_id, task, algo, params, metrics, created_at  
- **Predictions**: symbol, date, y_pred, interval_low/high, model_id  
- **Portfolio**: weights, constraints, risk_metrics  

---

## 6. API Design (Internal Python Interfaces)
- `DataAccess.get_prices(symbols, start, end, interval)`
- `FeatureBuilder.build(price_df, fundamentals_df, config)`
- `ModelTrainer.train(task, dataset, algo, params)`
- `ModelRegistry.save(model_obj, meta)` / `load(task)`
- `Forecaster.predict(model, X)`
- `Screener.rank(candidates, weights, filters)`
- `Portfolio.optimize(returns, cov, constraints)`
- `Reporter.to_pdf(context)` / `to_excel(context)`

---

## 7. Configuration & Secrets
- **config.yml**: ãƒ‡ãƒ¼ã‚¿æœŸé–“ã€å¯¾è±¡æŒ‡æ•°ã€é€šè²¨ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°é‡ã¿ã€å­¦ç¿’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚  
- **.env**: APIã‚­ãƒ¼ã€ãƒ—ãƒ­ã‚­ã‚·ã€ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å…ˆã€‚  
- **ç’°å¢ƒåˆ‡æ›¿**: `config.local.yml` / `config.prod.yml`ï¼ˆå°†æ¥ï¼‰ã€‚  

---

## 8. Observability & Quality
- **Logging**: INFOï¼ˆæ“ä½œ/å‡¦ç†æ™‚é–“ï¼‰ã€DEBUGï¼ˆç‰¹å¾´é‡/ãƒ‘ãƒ©ãƒ¡ã‚¿ï¼‰ã€‚  
- **Metrics**: å­¦ç¿’/æ¨è«–æ™‚é–“ã€ãƒ¢ãƒ‡ãƒ«æŒ‡æ¨™ã€ãƒ‡ãƒ¼ã‚¿æ¬ æç‡ã€‚  
- **Reports**: ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒè¡¨ã€ãƒ‰ãƒªãƒ•ãƒˆç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆã€‚  

---

## 9. Security & Compliance
- å¤–éƒ¨é€ä¿¡ã‚’æœ€å°åŒ–ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨±å®¹ï¼‰ã€HTTPSï¼ˆå°†æ¥çš„ã«Flaskä½µç”¨æ™‚ï¼‰ã€‚  
- ãƒ‡ãƒ¼ã‚¿/ãƒ¢ãƒ‡ãƒ«/ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€åˆ†é›¢ã¨ã‚¢ã‚¯ã‚»ã‚¹æ¨©ç®¡ç†ã€‚  
- å…è²¬è¡¨ç¤ºã®UIå¸¸è¨­ï¼ˆæŠ•è³‡åŠ©è¨€ã§ã¯ãªãæƒ…å ±æä¾›ï¼‰ã€‚  

---

## 10. Performance Targets
- UIæ“ä½œâ†’çµæœ: 5ç§’ä»¥å†…ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨æ™‚ï¼‰ã€‚  
- ãƒãƒƒãƒETL(100ã€œ300éŠ˜æŸ„/1å¹´åˆ†): 3ã€œ10åˆ†ç›®å®‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«CPUï¼‰ã€‚  
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: 5ã€œ30ç§’ã€‚  

---

## 11. Testing Strategy
- **Unit**: å„ã‚µãƒ¼ãƒ“ã‚¹/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆpytestï¼‰ã€‚  
- **Integration**: ETLâ†’Featureâ†’Trainâ†’Registry ã®é€šã—ç¢ºèªã€‚  
- **E2E**: Streamlit UI ãƒ†ã‚¹ãƒˆï¼ˆplaywright/selenium ç°¡æ˜“ï¼‰ã€‚  
- **Data Tests**: Great Expectations ä»£æ›¿ã®è»½é‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ¬ æãƒ»ç¯„å›²ï¼‰ã€‚  

---

## 12. CI/CD & Packaging
- **CI**: Lint + Unit + å°è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã§ã®Smokeå­¦ç¿’ã€‚  
- **Artifact**: `models/`, `reports/` ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆæ—¥ä»˜+hashï¼‰ã€‚  
- **Packaging**: `pipx` / `uv` å¯¾å¿œã€Dockerã¯ä»»æ„ã€‚  

---

## 13. Risks & Mitigations
- **ãƒ‡ãƒ¼ã‚¿å“è³ªã®ã°ã‚‰ã¤ã** â†’ å‰å‡¦ç†ã®å¼·åŒ–ã€ãƒ•ã‚§ã‚¤ãƒ«ã‚½ãƒ•ãƒˆï¼ˆæ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰ã€‚  
- **ãƒ¢ãƒ‡ãƒ«éå­¦ç¿’** â†’ æ™‚ç³»åˆ—CVã€æ­£å‰‡åŒ–ã€å˜ç´”ãƒ¢ãƒ‡ãƒ«ã®ä½µç”¨ã€‚  
- **å®Ÿè¡Œæ™‚é–“ã®æ‚ªåŒ–** â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ä¸¦åˆ—å‡¦ç†ã€ç‰¹å¾´é‡å‰Šæ¸›ã€‚  
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®è¤‡é›‘åŒ–** â†’ ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆåˆå¿ƒè€…/ä¸­ç´šè€…ï¼‰ã‚’æä¾›ã€‚  

---

## 14. Roadmap (Architecture â†’ Implementation)
1. Skeleton å®Ÿè£…ï¼ˆå±¤/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰  
2. DataAccess + Cacheã€FeatureBuilder MVP  
3. Screening/Forecast/Portfolio ã®MVPçµ±åˆ  
4. Report å‡ºåŠ›ã€è¨­å®šUI  
5. Batch ETLã€é€±æ¬¡å†å­¦ç¿’  
6. ãƒªã‚¹ã‚¯åˆ†æï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹/NLPï¼‰å¼·åŒ–  

---

## 15. Directory Layout (Proposal)

```plantuml
@startmindmap
* <b><color:Black>smart-market-ai</color></b>
** <color:Blue>app</color>
*** <color:DeepSkyBlue>ui</color> (streamlit pages)
*** <color:Green>services</color>
**** screening.py
**** forecast.py
**** portfolio.py
**** risk.py
**** report.py
*** <color:DarkGoldenRod>domain</color>
**** data_access.py
**** feature_store.py
**** model_registry.py
**** orchestrator.py
*** <color:DarkRed>infra</color>
**** storage.py
**** logging.py
**** secrets.py
** <color:OrangeRed>batch</color>
*** etl_daily.py
*** retrain_weekly.py
** <color:Purple>configs</color>
*** config.yml
** <color:DarkCyan>data</color>
*** raw
*** processed
*** features
*** cache
** models
** reports
** tests
** README.md
scale 500 width
@endmindmap
```

---

## 16. Open Questions
- æµ·å¤–æ ªã®**ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ**ã®æ‰±ã„ï¼ˆã‚¹ãƒãƒƒãƒˆ/çµ‚å€¤ã€æ‰‹æ•°æ–™æƒ³å®šï¼‰ã€‚  
- **æŠ•ä¿¡ãƒ‡ãƒ¼ã‚¿**ã®æ¨™æº–åŒ–ã‚½ãƒ¼ã‚¹ï¼ˆä¿¡è¨—å ±é…¬ã€ãƒªã‚¹ã‚¯æŒ‡æ¨™ï¼‰ã€‚  
- ãƒªã‚¹ã‚¯åˆ†æã®**ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—**ï¼ˆRSS/æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å½“é¢é‹ç”¨ï¼‰ã€‚  

---

### Appendix: Minimal Tech Choices
- **DB**: SQLiteï¼ˆâ†’ DuckDB æ‹¡å¼µä½™åœ°ï¼‰  
- **ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼**: Parquetï¼ˆfeaturesï¼‰, CSVï¼ˆraw/cacheï¼‰, XLSX/PDFï¼ˆreportsï¼‰  
- **ãƒ¢ãƒ‡ãƒªãƒ³ã‚°**: Prophetï¼ˆæŒ‡æ•°ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰ã€XGBoost/LightGBMï¼ˆéŠ˜æŸ„ï¼‰ã€LR baseline  
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©**: cron/Task Scheduler  

